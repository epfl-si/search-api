- name: SearchAPI - Secrets
  openshift:
    apiVersion: v1
    kind: Secret
    metadata:
      name: search-api-secrets
      namespace: '{{ openshift_namespace }}'
    type: Opaque
    data: >-
      {{ _data | from_yaml }}
  vars:
    _data: |
      SEARCH_API_ENABLE_CSE: "{{ searchapi_secrets.SEARCH_API_ENABLE_CSE | b64encode }}"
      SEARCH_API_ENABLE_LDAP: "{{ searchapi_secrets.SEARCH_API_ENABLE_LDAP | b64encode }}"
      SEARCH_API_ENABLE_UNIT: "{{ searchapi_secrets.SEARCH_API_ENABLE_UNIT | b64encode }}"
      SEARCH_API_ENABLE_GRAPHSEARCH: "{{ searchapi_secrets.SEARCH_API_ENABLE_GRAPHSEARCH | b64encode }}"
      SEARCH_API_CSE_API_KEY: "{{ searchapi_secrets.SEARCH_API_CSE_API_KEY | b64encode }}"
      SEARCH_API_CSE_CX: "{{ searchapi_secrets.SEARCH_API_CSE_CX | b64encode }}"
      SEARCH_API_CADIDB_HOST: "{{ searchapi_secrets.SEARCH_API_CADIDB_HOST | b64encode }}"
      SEARCH_API_CADIDB_PORT: "{{ searchapi_secrets.SEARCH_API_CADIDB_PORT | b64encode }}"
      SEARCH_API_CADIDB_DATABASE: "{{ searchapi_secrets.SEARCH_API_CADIDB_DATABASE | b64encode }}"
      SEARCH_API_CADIDB_USER: "{{ searchapi_secrets.SEARCH_API_CADIDB_USER | b64encode }}"
      SEARCH_API_CADIDB_PASSWORD: "{{ searchapi_secrets.SEARCH_API_CADIDB_PASSWORD | b64encode }}"
      SEARCH_API_LDAP_URL: "{{ searchapi_secrets.SEARCH_API_LDAP_URL | b64encode }}"
      SEARCH_API_LDAP_ROOTS_FILTER: "{{ searchapi_secrets.SEARCH_API_LDAP_ROOTS_FILTER | b64encode }}"

- name: SearchAPI - Deployment
  openshift:
    apiVersion: extensions/v1beta1
    kind: Deployment
    metadata:
      name: '{{ app_name }}'
      namespace: '{{ openshift_namespace }}'
      labels:
        app: '{{ app_name }}'
        team: '{{ team }}'
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: '{{ app_name }}'
      template:
        metadata:
          labels:
            app: '{{ app_name }}'
            team: '{{ team }}'
            role: webserver
        spec:
          containers:
            - env:
                - name: SEARCH_API_ENABLE_CSE
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_ENABLE_CSE
                - name: SEARCH_API_ENABLE_LDAP
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_ENABLE_LDAP
                - name: SEARCH_API_ENABLE_UNIT
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_ENABLE_UNIT
                - name: SEARCH_API_ENABLE_GRAPHSEARCH
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_ENABLE_GRAPHSEARCH
                - name: SEARCH_API_CSE_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_CSE_API_KEY
                - name: SEARCH_API_CSE_CX
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_CSE_CX
                - name: SEARCH_API_CADIDB_HOST
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_CADIDB_HOST
                - name: SEARCH_API_CADIDB_PORT
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_CADIDB_PORT
                - name: SEARCH_API_CADIDB_DATABASE
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_CADIDB_DATABASE
                - name: SEARCH_API_CADIDB_USER
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_CADIDB_USER
                - name: SEARCH_API_CADIDB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_CADIDB_PASSWORD
                - name: SEARCH_API_LDAP_URL
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_LDAP_URL
                - name: SEARCH_API_LDAP_ROOTS_FILTER
                  valueFrom:
                    secretKeyRef:
                      name: search-api-secrets
                      key: SEARCH_API_LDAP_ROOTS_FILTER
              name: '{{ app_name }}'
              image: 'docker-registry.default.svc:5000/{{ openshift_namespace }}/search-api:latest'
              imagePullPolicy: Always
          dnsPolicy: ClusterFirst
          restartPolicy: Always
          schedulerName: default-scheduler
          terminationGracePeriodSeconds: 30

- name: SearchAPI - Service
  openshift:
    state: latest
    apiVersion: v1
    kind: Service
    metadata:
      name: '{{ app_name }}'
      namespace: '{{ openshift_namespace }}'
      labels:
        app: '{{ app_name }}'
        team: '{{ team }}'
    spec:
      type: ClusterIP
      ports:
        - name: '80'
          port: 80
          protocol: TCP
          targetPort: 5555
      selector:
        app: '{{ app_name }}'
        role: webserver
